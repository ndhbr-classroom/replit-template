#!/bin/bash
workspace_path=`dirname $(dirname $(realpath $0))`

# loading
showLoading() {
    pid=$!
    loadingText="Uploading"

    echo -ne "$loadingText\r"

    while kill -0 $pid 2>/dev/null; do
    echo -ne "$loadingText.\r"
    sleep 0.25
    echo -ne "$loadingText..\r"
    sleep 0.25
    echo -ne "$loadingText...\r"
    sleep 0.25
    echo -ne "\r\033[K"
    echo -ne "$loadingText\r"
    sleep 0.25
    done

    printf "$loadingText finished.\n"
    printf "In a few moments, you should see your assessment in GitHub Classroom.\n"
}

# git upload
commitAndPushChanges() {
    git add .
    git commit -m "Automated commmit" --quiet
    git push -u origin master --quiet
}

# check for parameter
if [ -z "$1" ]
then
    printf "Usage: submit <REPOSITORY-NAME>\n"
else
    # check wether folder exists
    if [ ! -d "$workspace_path/$1" ]; then
        printf "Exercise does not exist in your space\n"
        exit 1
    fi

    cd $workspace_path/$1

    # if changed something
    if [[ `git status --porcelain` ]]; then
        printf "Preparing to submit your attempt...\n"

        commitAndPushChanges & showLoading
    fi
    cd ..
fi
